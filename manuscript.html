<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Study Team">
<meta name="dcterms.date" content="2026-02-13">

<title>Evaluation of DSPy-Optimized AI Assistance for Clinical Handover</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="manuscript_files/libs/clipboard/clipboard.min.js"></script>
<script src="manuscript_files/libs/quarto-html/quarto.js"></script>
<script src="manuscript_files/libs/quarto-html/popper.min.js"></script>
<script src="manuscript_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="manuscript_files/libs/quarto-html/anchor.min.js"></script>
<link href="manuscript_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="manuscript_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="manuscript_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="manuscript_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="manuscript_files/libs/bootstrap/bootstrap-c0367b04c37547644fece4185067e4a7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-abstract" id="toc-sec-abstract" class="nav-link active" data-scroll-target="#sec-abstract"><span class="header-section-number">1</span> Abstract</a></li>
  <li><a href="#sec-introduction" id="toc-sec-introduction" class="nav-link" data-scroll-target="#sec-introduction"><span class="header-section-number">2</span> Introduction</a></li>
  <li><a href="#sec-methods" id="toc-sec-methods" class="nav-link" data-scroll-target="#sec-methods"><span class="header-section-number">3</span> Methods</a>
  <ul class="collapse">
  <li><a href="#study-design" id="toc-study-design" class="nav-link" data-scroll-target="#study-design"><span class="header-section-number">3.1</span> Study design</a></li>
  <li><a href="#data-and-annotation-workflow" id="toc-data-and-annotation-workflow" class="nav-link" data-scroll-target="#data-and-annotation-workflow"><span class="header-section-number">3.2</span> Data and annotation workflow</a></li>
  <li><a href="#model-development-and-optimization" id="toc-model-development-and-optimization" class="nav-link" data-scroll-target="#model-development-and-optimization"><span class="header-section-number">3.3</span> Model development and optimization</a></li>
  <li><a href="#evaluation-setting" id="toc-evaluation-setting" class="nav-link" data-scroll-target="#evaluation-setting"><span class="header-section-number">3.4</span> Evaluation setting</a></li>
  <li><a href="#data-analysis" id="toc-data-analysis" class="nav-link" data-scroll-target="#data-analysis"><span class="header-section-number">3.5</span> Data analysis</a></li>
  </ul></li>
  <li><a href="#sec-results" id="toc-sec-results" class="nav-link" data-scroll-target="#sec-results"><span class="header-section-number">4</span> Results</a>
  <ul class="collapse">
  <li><a href="#sec-results-summary" id="toc-sec-results-summary" class="nav-link" data-scroll-target="#sec-results-summary"><span class="header-section-number">4.1</span> Key findings</a></li>
  <li><a href="#sec-sbar-optimized" id="toc-sec-sbar-optimized" class="nav-link" data-scroll-target="#sec-sbar-optimized"><span class="header-section-number">4.2</span> SBAR span extraction: per-label optimized performance</a></li>
  <li><a href="#sec-checklist" id="toc-sec-checklist" class="nav-link" data-scroll-target="#sec-checklist"><span class="header-section-number">4.3</span> Checklist task: grouped per-label performance</a></li>
  </ul></li>
  <li><a href="#sec-discussion" id="toc-sec-discussion" class="nav-link" data-scroll-target="#sec-discussion"><span class="header-section-number">5</span> Discussion</a></li>
  <li><a href="#sec-limitations" id="toc-sec-limitations" class="nav-link" data-scroll-target="#sec-limitations"><span class="header-section-number">6</span> Limitations</a></li>
  <li><a href="#sec-conclusion" id="toc-sec-conclusion" class="nav-link" data-scroll-target="#sec-conclusion"><span class="header-section-number">7</span> Conclusion</a></li>
  <li><a href="#sec-reproducibility" id="toc-sec-reproducibility" class="nav-link" data-scroll-target="#sec-reproducibility"><span class="header-section-number">8</span> Reproducibility appendix</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="manuscript.docx"><i class="bi bi-file-word"></i>MS Word</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Evaluation of DSPy-Optimized AI Assistance for Clinical Handover</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Study Team </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 13, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="sec-abstract" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="sec-abstract"><span class="header-section-number">1</span> Abstract</h2>
<p>Accurate communication during clinical handover is critical for patient safety. We evaluated a DSPy-based pipeline for extracting structured handover information under two task settings: (1) SBAR span extraction and (2) checklist label prediction. Phase 1 methods used dual independent annotation by two clinically experienced annotators followed by consensus reconciliation. Prompt optimization was performed with DSPy, and evaluation was performed on held-out consensus test partitions. For SBAR span extraction, per-label analysis on 48 test examples showed higher macro-F1 for the optimized prompt pipeline than baseline (0.733 vs 0.494). The largest F1 gains were observed for BACKGROUND (+0.403) and SITUATION (+0.251), with improved precision across all SBAR labels. For checklist prediction (49 test examples), grouped per-label analysis showed strong pooled performance (micro-F1 0.854; support-weighted F1 0.849) with variation across label groups. These results support DSPy optimization as a practical method to improve clinically relevant information extraction while preserving transparent label-level evaluation.</p>
</section>
<section id="sec-introduction" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="sec-introduction"><span class="header-section-number">2</span> Introduction</h2>
<p>Clinical handover requires concise and accurate transfer of critical patient information. Errors or omissions in handover communication can lead to delays in treatment and patient harm. This manuscript reports model evaluation results from a study workflow focused on improving structured handover extraction using DSPy-guided prompt optimization and consensus-labeled data.</p>
</section>
<section id="sec-methods" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-methods"><span class="header-section-number">3</span> Methods</h2>
<section id="study-design" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="study-design"><span class="header-section-number">3.1</span> Study design</h3>
<p>This manuscript reports outcomes aligned to the Phase 1 objective in <code>proposal.md</code>: development of a generative AI pipeline to produce accurate handover recommendations and structured outputs.</p>
</section>
<section id="data-and-annotation-workflow" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="data-and-annotation-workflow"><span class="header-section-number">3.2</span> Data and annotation workflow</h3>
<p>Phase 1 described three sources of handover data and planned annotation of 203 transcripts. Two clinically experienced annotators independently annotated transcripts using a structured rubric, then discrepancies were reconciled through consensus meetings with the broader investigator team and consumer partner. This consensus process produced the reference labels used for downstream model development and evaluation.</p>
</section>
<section id="model-development-and-optimization" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="model-development-and-optimization"><span class="header-section-number">3.3</span> Model development and optimization</h3>
<p>Model orchestration used DSPy (<code>dspy</code>) for predictor construction, configuration, and optimization. The span and checklist tasks used task-specific signatures and DSPy optimization workflows. In this report, SBAR span extraction compares:</p>
<ol type="1">
<li>Baseline prompt pipeline (initial DSPy signature without trained program loading).</li>
<li>DSPy-optimized prompt/program configuration.</li>
</ol>
</section>
<section id="evaluation-setting" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="evaluation-setting"><span class="header-section-number">3.4</span> Evaluation setting</h3>
<p>Evaluation scripts used held-out test partitions (default behavior without <code>--use-all</code>) from deterministic 75/25 splits in <code>src/data/dataset.py</code> (local RNG seed 339). Reported artifacts:</p>
<ol type="1">
<li>SBAR baseline: <code>evals/eval_sbar_span_consensus_test_baseline_gpt_5.2.jsonl</code> (48 test examples).</li>
<li>SBAR optimized: <code>evals/eval_sbar_span_gpt5-2_consensus_test.jsonl</code> (48 test examples).</li>
<li>Checklist grouped per-label analysis: rendered with <code>analysis/render_checklist_md_table.py</code> from <code>evals/eval_checklist_consensus_gpt_5_2_test_analysis/per_label.csv</code> and baseline <code>evals/eval_baseline_checklist_consensus_gpt_5_2_test_analysis/per_label.csv</code>, based on <code>evals/eval_checklist_consensus_gpt_5_2_test.jsonl</code> (49 test examples).</li>
</ol>
<p>Per-label SBAR metrics were generated with <code>analysis/per_label_analysis.py</code>, reporting support, matched spans, recall, precision, F1, and mean IoU.</p>
</section>
<section id="data-analysis" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="data-analysis"><span class="header-section-number">3.5</span> Data analysis</h3>
<p>For both tasks, performance was summarized with standard classification metrics:</p>
<ol type="1">
<li>Precision = true positives / (true positives + false positives).</li>
<li>Recall = true positives / (true positives + false negatives).</li>
<li>F1 score = harmonic mean of precision and recall.</li>
</ol>
<p>For SBAR span extraction, <code>analysis/per_label_analysis.py</code> computes metrics per SBAR label using matched gold-predicted span pairs from <code>prediction.span_metrics.detailed</code>:</p>
<ol type="1">
<li><code>Gold</code>: number of reference spans for that label.</li>
<li><code>Predicted spans</code>: number of model-predicted spans for that label.</li>
<li><code>Recall</code>: proportion of gold spans that were matched.</li>
<li><code>Precision</code>: proportion of predicted spans that were matched.</li>
<li><code>F1</code>: balance between precision and recall per label.</li>
<li><code>Mean IoU</code>: average intersection-over-union of matched spans, quantifying boundary overlap quality.</li>
</ol>
<p>For checklist analysis, the grouped table reports per-label confusion-derived counts (<code>TP</code>, <code>FP</code>, <code>FN</code>, <code>TN</code>) and derived precision, recall, and F1. Aggregate summary metrics are:</p>
<ol type="1">
<li>Micro averages: pooled counts across all labels before computing precision/recall/F1.</li>
<li>Macro averages: unweighted mean of label-level precision/recall/F1.</li>
<li>Support-weighted averages: label-level metrics weighted by label support.</li>
</ol>
</section>
</section>
<section id="sec-results" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="sec-results"><span class="header-section-number">4</span> Results</h2>
<section id="sec-results-summary" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="sec-results-summary"><span class="header-section-number">4.1</span> Key findings</h3>
<p>On the SBAR span extraction task, DSPy optimization improved performance on the consensus test partition (<code>n=48</code>), increasing macro-F1 from 0.494 to 0.733 (+0.239) and macro-precision from 0.406 to 0.761. The largest per-label improvements in F1 were observed for BACKGROUND (+0.403), SITUATION (+0.251), and ASSESSMENT (+0.214), with a smaller gain for RECOMMENDATION (+0.089). Span boundary overlap quality remained high, with mean IoU values between 0.688 and 0.794 across SBAR labels. For the checklist task, pooled performance on the consensus test partition (<code>n=49</code>) was strong (micro-F1 0.854, +0.081 vs baseline; macro-F1 0.762, +0.073), while a subset of low-support labels remained challenging, including labels with F1=0.</p>
</section>
<section id="sec-sbar-optimized" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="sec-sbar-optimized"><span class="header-section-number">4.2</span> SBAR span extraction: per-label optimized performance</h3>
<p><a href="#tbl-sbar-optimized" class="quarto-xref">Table&nbsp;1</a> summarizes per-label results for the DSPy-optimized GPT-5.2 SBAR span pipeline.</p>
<div id="tbl-sbar-optimized" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-sbar-optimized-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Per-label SBAR metrics for DSPy-optimized model output on the consensus test partition (<code>n=48</code>). <code>Delta F1</code> is optimized minus baseline F1 from the same partition.
</figcaption>
<div aria-describedby="tbl-sbar-optimized-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>Label</th>
<th style="text-align: right;">Gold</th>
<th style="text-align: right;">Predicted spans</th>
<th style="text-align: right;">Recall</th>
<th style="text-align: right;">Precision</th>
<th style="text-align: right;">Mean IoU</th>
<th style="text-align: right;">F1</th>
<th style="text-align: right;">Delta F1 (vs baseline)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ASSESSMENT</td>
<td style="text-align: right;">194</td>
<td style="text-align: right;">178</td>
<td style="text-align: right;">0.727</td>
<td style="text-align: right;">0.792</td>
<td style="text-align: right;">0.762</td>
<td style="text-align: right;">0.758</td>
<td style="text-align: right;">+0.214</td>
</tr>
<tr class="even">
<td>BACKGROUND</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">56</td>
<td style="text-align: right;">0.766</td>
<td style="text-align: right;">0.643</td>
<td style="text-align: right;">0.688</td>
<td style="text-align: right;">0.699</td>
<td style="text-align: right;">+0.403</td>
</tr>
<tr class="odd">
<td>RECOMMENDATION</td>
<td style="text-align: right;">113</td>
<td style="text-align: right;">129</td>
<td style="text-align: right;">0.717</td>
<td style="text-align: right;">0.628</td>
<td style="text-align: right;">0.791</td>
<td style="text-align: right;">0.669</td>
<td style="text-align: right;">+0.089</td>
</tr>
<tr class="even">
<td>SITUATION</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">0.685</td>
<td style="text-align: right;">0.980</td>
<td style="text-align: right;">0.794</td>
<td style="text-align: right;">0.806</td>
<td style="text-align: right;">+0.251</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>Across SBAR labels, macro-precision improved from 0.406 to 0.761, macro-recall from 0.686 to 0.724, and macro-F1 from 0.494 to 0.733.</p>
</section>
<section id="sec-checklist" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="sec-checklist"><span class="header-section-number">4.3</span> Checklist task: grouped per-label performance</h3>
<p>The grouped checklist per-label analysis is provided in Table <a href="#tbl-checklist-grouped" class="quarto-xref">Table&nbsp;2</a>.</p>
<div id="tbl-checklist-grouped" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-checklist-grouped-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Grouped checklist label performance on the consensus test partition (<code>n=49</code>).
</figcaption>
<div aria-describedby="tbl-checklist-grouped-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th>Category</th>
<th>Label</th>
<th style="text-align: right;">Support</th>
<th style="text-align: right;">TP</th>
<th style="text-align: right;">FP</th>
<th style="text-align: right;">FN</th>
<th style="text-align: right;">TN</th>
<th style="text-align: right;">Precision</th>
<th style="text-align: right;">ΔPrecision vs Baseline</th>
<th style="text-align: right;">Recall</th>
<th style="text-align: right;">ΔRecall vs Baseline</th>
<th style="text-align: right;">F1</th>
<th style="text-align: right;">ΔF1 vs Baseline</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Identification</td>
<td>ID check of 3 patient identifiers</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.944</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.895</td>
</tr>
<tr class="even">
<td>Situation</td>
<td>Primary diagnosis | reason for admission</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.957</td>
<td style="text-align: right;">+0.020</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.978</td>
<td style="text-align: right;">+0.011</td>
</tr>
<tr class="odd">
<td>Situation</td>
<td>Current status (awaiting tests/procedures, on interim orders/plan)</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.733</td>
<td style="text-align: right;">+0.033</td>
<td style="text-align: right;">0.710</td>
<td style="text-align: right;">-0.194</td>
<td style="text-align: right;">0.721</td>
<td style="text-align: right;">-0.067</td>
</tr>
<tr class="even">
<td>Situation</td>
<td>Significant events or complications</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">0.625</td>
<td style="text-align: right;">+0.292</td>
<td style="text-align: right;">0.500</td>
<td style="text-align: right;">-0.100</td>
<td style="text-align: right;">0.556</td>
<td style="text-align: right;">+0.127</td>
</tr>
<tr class="odd">
<td>Situation</td>
<td><strong>Subtotal (Situation)</strong></td>
<td style="text-align: right;"><strong>86</strong></td>
<td style="text-align: right;"><strong>72</strong></td>
<td style="text-align: right;"><strong>13</strong></td>
<td style="text-align: right;"><strong>14</strong></td>
<td style="text-align: right;"><strong>48</strong></td>
<td style="text-align: right;"><strong>0.847</strong></td>
<td style="text-align: right;"><strong>+0.102</strong></td>
<td style="text-align: right;"><strong>0.837</strong></td>
<td style="text-align: right;"><strong>-0.081</strong></td>
<td style="text-align: right;"><strong>0.842</strong></td>
<td style="text-align: right;"><strong>+0.019</strong></td>
</tr>
<tr class="even">
<td>Background</td>
<td>Alerts - allergies</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">0.889</td>
<td style="text-align: right;">-0.011</td>
<td style="text-align: right;">0.889</td>
<td style="text-align: right;">-0.111</td>
<td style="text-align: right;">0.889</td>
<td style="text-align: right;">-0.058</td>
</tr>
<tr class="odd">
<td>Background</td>
<td>Relevant clinical and social history | comorbidities</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">0.944</td>
<td style="text-align: right;">+0.135</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.971</td>
<td style="text-align: right;">+0.077</td>
</tr>
<tr class="even">
<td>Background</td>
<td>Alerts - falls risk</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.250</td>
<td style="text-align: right;">0.667</td>
<td style="text-align: right;">-0.333</td>
<td style="text-align: right;">0.800</td>
<td style="text-align: right;">-0.057</td>
</tr>
<tr class="odd">
<td>Background</td>
<td>Alerts - pressure injury risk</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.667</td>
<td style="text-align: right;">-0.333</td>
<td style="text-align: right;">0.800</td>
<td style="text-align: right;">-0.200</td>
</tr>
<tr class="even">
<td>Background</td>
<td>Advanced care planning</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
</tr>
<tr class="odd">
<td>Background</td>
<td><strong>Subtotal (Background)</strong></td>
<td style="text-align: right;"><strong>42</strong></td>
<td style="text-align: right;"><strong>38</strong></td>
<td style="text-align: right;"><strong>3</strong></td>
<td style="text-align: right;"><strong>4</strong></td>
<td style="text-align: right;"><strong>200</strong></td>
<td style="text-align: right;"><strong>0.927</strong></td>
<td style="text-align: right;"><strong>+0.070</strong></td>
<td style="text-align: right;"><strong>0.905</strong></td>
<td style="text-align: right;"><strong>-0.095</strong></td>
<td style="text-align: right;"><strong>0.916</strong></td>
<td style="text-align: right;"><strong>-0.007</strong></td>
</tr>
<tr class="even">
<td>Assessment</td>
<td>Observations | Q-ADDS | recent escalations</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.950</td>
<td style="text-align: right;">+0.023</td>
<td style="text-align: right;">0.950</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.950</td>
<td style="text-align: right;">+0.012</td>
</tr>
<tr class="odd">
<td>Assessment</td>
<td>Medication chart | flag high risk meds</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0.857</td>
<td style="text-align: right;">+0.030</td>
<td style="text-align: right;">0.960</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.906</td>
<td style="text-align: right;">+0.017</td>
</tr>
<tr class="even">
<td>Assessment</td>
<td>Devices | lines | vascular access</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">0.885</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.939</td>
<td style="text-align: right;">+0.000</td>
</tr>
<tr class="odd">
<td>Assessment</td>
<td>Mobility | aids</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">0.800</td>
<td style="text-align: right;">+0.027</td>
<td style="text-align: right;">0.941</td>
<td style="text-align: right;">-0.059</td>
<td style="text-align: right;">0.865</td>
<td style="text-align: right;">-0.007</td>
</tr>
<tr class="even">
<td>Assessment</td>
<td>Pain management</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">0.889</td>
<td style="text-align: right;">+0.222</td>
<td style="text-align: right;">0.941</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.914</td>
<td style="text-align: right;">+0.134</td>
</tr>
<tr class="odd">
<td>Assessment</td>
<td>Infusions</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">0.889</td>
<td style="text-align: right;">+0.089</td>
<td style="text-align: right;">0.533</td>
<td style="text-align: right;">-0.267</td>
<td style="text-align: right;">0.667</td>
<td style="text-align: right;">-0.133</td>
</tr>
<tr class="even">
<td>Assessment</td>
<td>Pathology</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">0.737</td>
<td style="text-align: right;">-0.063</td>
<td style="text-align: right;">0.933</td>
<td style="text-align: right;">+0.133</td>
<td style="text-align: right;">0.824</td>
<td style="text-align: right;">+0.024</td>
</tr>
<tr class="odd">
<td>Assessment</td>
<td>Nutrition | restrictions</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">0.700</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.824</td>
<td style="text-align: right;">+0.000</td>
</tr>
<tr class="even">
<td>Assessment</td>
<td>Fluid balance | restrictions</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">0.700</td>
<td style="text-align: right;">-0.050</td>
<td style="text-align: right;">0.778</td>
<td style="text-align: right;">-0.222</td>
<td style="text-align: right;">0.737</td>
<td style="text-align: right;">-0.120</td>
</tr>
<tr class="odd">
<td>Assessment</td>
<td>Skin integrity | interventions</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">0.545</td>
<td style="text-align: right;">+0.045</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.706</td>
<td style="text-align: right;">+0.039</td>
</tr>
<tr class="even">
<td>Assessment</td>
<td>Critical monitoring | alarms</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">+0.000</td>
</tr>
<tr class="odd">
<td>Assessment</td>
<td><strong>Subtotal (Assessment)</strong></td>
<td style="text-align: right;"><strong>181</strong></td>
<td style="text-align: right;"><strong>166</strong></td>
<td style="text-align: right;"><strong>37</strong></td>
<td style="text-align: right;"><strong>15</strong></td>
<td style="text-align: right;"><strong>321</strong></td>
<td style="text-align: right;"><strong>0.818</strong></td>
<td style="text-align: right;"><strong>+0.044</strong></td>
<td style="text-align: right;"><strong>0.917</strong></td>
<td style="text-align: right;"><strong>-0.028</strong></td>
<td style="text-align: right;"><strong>0.865</strong></td>
<td style="text-align: right;"><strong>+0.014</strong></td>
</tr>
<tr class="even">
<td>Recommendation</td>
<td>Care plan/pathway actions to follow up</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.898</td>
<td style="text-align: right;">-0.035</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.045</td>
<td style="text-align: right;">0.946</td>
<td style="text-align: right;">+0.002</td>
</tr>
<tr class="odd">
<td>Recommendation</td>
<td>Asked patient/carer about goals and preferences</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-0.500</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-0.222</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-0.308</td>
</tr>
<tr class="even">
<td>Recommendation</td>
<td>Discharge plan</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">0.800</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.889</td>
<td style="text-align: right;">+0.000</td>
</tr>
<tr class="odd">
<td>Recommendation</td>
<td>Critical actions required</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">0.200</td>
<td style="text-align: right;">+0.170</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.000</td>
<td style="text-align: right;">0.333</td>
<td style="text-align: right;">+0.275</td>
</tr>
<tr class="even">
<td>Recommendation</td>
<td><strong>Subtotal (Recommendation)</strong></td>
<td style="text-align: right;"><strong>58</strong></td>
<td style="text-align: right;"><strong>49</strong></td>
<td style="text-align: right;"><strong>11</strong></td>
<td style="text-align: right;"><strong>9</strong></td>
<td style="text-align: right;"><strong>127</strong></td>
<td style="text-align: right;"><strong>0.817</strong></td>
<td style="text-align: right;"><strong>+0.253</strong></td>
<td style="text-align: right;"><strong>0.845</strong></td>
<td style="text-align: right;"><strong>+0.000</strong></td>
<td style="text-align: right;"><strong>0.831</strong></td>
<td style="text-align: right;"><strong>+0.155</strong></td>
</tr>
<tr class="odd">
<td>Patient Involvement</td>
<td>Introduction of clinicians involved in handover to patient/carer</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0.714</td>
<td style="text-align: right;">-0.036</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">+0.850</td>
<td style="text-align: right;">0.833</td>
<td style="text-align: right;">+0.583</td>
</tr>
<tr class="even">
<td>Patient Involvement</td>
<td>Invitation for patient/carer to participate in handover</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">0.652</td>
<td style="text-align: right;">-0.014</td>
<td style="text-align: right;">0.938</td>
<td style="text-align: right;">-0.062</td>
<td style="text-align: right;">0.769</td>
<td style="text-align: right;">-0.031</td>
</tr>
<tr class="odd">
<td>Patient Involvement</td>
<td><strong>Subtotal (Patient Involvement)</strong></td>
<td style="text-align: right;"><strong>36</strong></td>
<td style="text-align: right;"><strong>35</strong></td>
<td style="text-align: right;"><strong>16</strong></td>
<td style="text-align: right;"><strong>1</strong></td>
<td style="text-align: right;"><strong>46</strong></td>
<td style="text-align: right;"><strong>0.686</strong></td>
<td style="text-align: right;"><strong>+0.290</strong></td>
<td style="text-align: right;"><strong>0.972</strong></td>
<td style="text-align: right;"><strong>+0.444</strong></td>
<td style="text-align: right;"><strong>0.805</strong></td>
<td style="text-align: right;"><strong>+0.352</strong></td>
</tr>
<tr class="even">
<td><strong>Overall (Micro)</strong></td>
<td><strong>All labels pooled</strong></td>
<td style="text-align: right;"><strong>404</strong></td>
<td style="text-align: right;"><strong>361</strong></td>
<td style="text-align: right;"><strong>80</strong></td>
<td style="text-align: right;"><strong>43</strong></td>
<td style="text-align: right;"><strong>790</strong></td>
<td style="text-align: right;"><strong>0.819</strong></td>
<td style="text-align: right;"><strong>+0.136</strong></td>
<td style="text-align: right;"><strong>0.894</strong></td>
<td style="text-align: right;"><strong>+0.000</strong></td>
<td style="text-align: right;"><strong>0.854</strong></td>
<td style="text-align: right;"><strong>+0.081</strong></td>
</tr>
<tr class="odd">
<td><strong>Overall (Macro)</strong></td>
<td><strong>Unweighted label mean</strong></td>
<td style="text-align: right;"><strong>-</strong></td>
<td style="text-align: right;"><strong>-</strong></td>
<td style="text-align: right;"><strong>-</strong></td>
<td style="text-align: right;"><strong>-</strong></td>
<td style="text-align: right;"><strong>-</strong></td>
<td style="text-align: right;"><strong>0.745</strong></td>
<td style="text-align: right;"><strong>+0.086</strong></td>
<td style="text-align: right;"><strong>0.823</strong></td>
<td style="text-align: right;"><strong>-0.002</strong></td>
<td style="text-align: right;"><strong>0.762</strong></td>
<td style="text-align: right;"><strong>+0.073</strong></td>
</tr>
<tr class="even">
<td><strong>Overall (Support-Weighted)</strong></td>
<td><strong>Weighted by label support</strong></td>
<td style="text-align: right;"><strong>404</strong></td>
<td style="text-align: right;"><strong>-</strong></td>
<td style="text-align: right;"><strong>-</strong></td>
<td style="text-align: right;"><strong>-</strong></td>
<td style="text-align: right;"><strong>-</strong></td>
<td style="text-align: right;"><strong>0.822</strong></td>
<td style="text-align: right;"><strong>+0.020</strong></td>
<td style="text-align: right;"><strong>0.894</strong></td>
<td style="text-align: right;"><strong>+0.000</strong></td>
<td style="text-align: right;"><strong>0.849</strong></td>
<td style="text-align: right;"><strong>+0.023</strong></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
</section>
<section id="sec-discussion" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="sec-discussion"><span class="header-section-number">5</span> Discussion</h2>
<p>These results show meaningful performance gains after DSPy optimization for SBAR span extraction, especially through precision improvements in BACKGROUND and SITUATION labels. RECOMMENDATION recall decreased, indicating a remaining trade-off between reducing false positives and preserving complete capture of recommendation spans.</p>
<p>Checklist results indicate strong aggregate discrimination on the consensus test partition, with variability concentrated in lower-support labels and categories with sparse positives. This pattern is expected in clinical label spaces where some safety-relevant signals are uncommon but high impact.</p>
</section>
<section id="sec-limitations" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="sec-limitations"><span class="header-section-number">6</span> Limitations</h2>
<ol type="1">
<li>Reported metrics are from a single deterministic split and should be supplemented with repeated split or external validation.</li>
<li>Some labels have low support, which increases metric variance.</li>
<li>This manuscript reports performance metrics only; impact on clinician workflow and patient outcomes requires prospective evaluation.</li>
</ol>
</section>
<section id="sec-conclusion" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="sec-conclusion"><span class="header-section-number">7</span> Conclusion</h2>
<p>Using consensus-labeled clinical handover data and DSPy-based optimization, we observed improved SBAR span extraction performance over baseline and strong checklist classification performance on held-out test data. Label-level reporting highlighted both gains and remaining gaps, supporting targeted next-step refinement.</p>
</section>
<section id="sec-reproducibility" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="sec-reproducibility"><span class="header-section-number">8</span> Reproducibility appendix</h2>
<p>The SBAR per-label values in this manuscript were produced with:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> analysis/per_label_analysis.py evals/eval_sbar_span_consensus_test_baseline_gpt_5.2.jsonl</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> analysis/per_label_analysis.py evals/eval_sbar_span_gpt5-2_consensus_test.jsonl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Checklist grouped table was rendered with:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> analysis/render_checklist_md_table.py <span class="dt">\</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  evals/eval_checklist_consensus_gpt_5_2_test_analysis/per_label.csv <span class="dt">\</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--summary-json</span> evals/eval_checklist_consensus_gpt_5_2_test_analysis/summary.json <span class="dt">\</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--baseline-per-label-csv</span> evals/eval_baseline_checklist_consensus_gpt_5_2_test_analysis/per_label.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>